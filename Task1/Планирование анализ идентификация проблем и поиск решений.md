# Планирование: анализ, идентификация проблем и поиск решений

## Проблемы и ограничения

1. Расчет стоимости заказанного изделия в среднем 2-3минуты. В сложных моделях до 30 минут.
2. После роста продаж появились жалобы клиентов о долгом выполнении заказа и над заказом работают уже несколько месяцев, когда обещали за 3 недели
3. По п.2 предварительно установлено, что проблемы не на стороне производства - производственные мощности позволяют выполнять заказы в обозначенные сроки и имеют двухкратный запас.
4. После внедрения API для других продавцов - количество жалоб на просроченные заказы стало больше
5. При использовании API представители компании жалуются что не получили свои заказы
6. Жалобы на MES - первая страница прогружается очень долго (на первой странице дашборд со списком заказов и их статусами)
7. По п.6 - добавление пагинации и фильтра проблему не решило
8. Недовольство онлайн магазином растет - потеря нескольких крупных клиентов
9. Деплой в release/prod окружение вручную
10. Значительное увеличение сроков выкатки изменений в релизную и продуктивную среды.

## Анализ текущего решения и поиск потенциальных проблемных мест.
По всей вероятности система строилась спонтанно, без выработки архитектурных подходов, учета изменения бизнеса.
Необходимо в первую очередь произвести изменения повышающую стабильность бизнеса. 
Так как предстоит достаточно много изменений, то параллельно проработать вопрос по ускорению выкатки изменений.
Далее составить реестр запланированных изменений и приоритезировать изменения изначально повышающие стабильность бизнеса, затем удовлетворенность клиентов.

## Анализ существующей архитектуры 
### Анализ по схеме в модели C4
1. Нет кэширования в Internet Shop. Напрашивается кэширование на стороне клиента (для пагинирования)
2. При загрузке 3d модели проходит цепочку Internet Shop -> Shop API -> 3d files storage - не хватает кэширования на запись.
3. Получение статусов заказов в CRM API происходит напрямую в БД ShopDB. Надо разделить ShopDB на 2 базы ShopDB и CRM DB для разделения информации для магазина и CRM. При этом CRM должен использовать Shop API. 
4. Инстансы развернуты в EC2, необходимо переносить в K8S. Проработать механизм горизонтального масштабирования: в первую очередь это касается MES.
5. По безопасности анализ не производится, но для MES API и для CRM (внешние продавцы) должны обеспечены усиленные меры безопасности - возможно прикрыть с помощью Gateway
### Анализ по схеме и проблемам
6. Расчет стоимости производится достаточно долго - обязательно надо переводить на асинхронное взаимодействие. 
Клиент должен отправить файл и не ждать результатов просчета. 
Если необходимо известить о результатах просчета, то клиент может уведомляться пуш сообщениями (sms, email, сайт), либо уведомлять прямо на главной странице.
7. По проблемам п.2 о долгом выполнении заказа - по всей видимости происходит потеря заказа. Например: потенциальная проблема в ShopDB при одновременной смене статуса после загрузке 3d модели и когда продавец забирает заказ на себя.
8. По проблемам п.3 - в существующей архитектуре не смогли локализовать место проблемы, так как полностью отсутствует наблюдение за системой. Необходимо:
   + Добавить мониторинг (graphana + prometheus). Ввести систему индикаторов и алертов для определения проблемных мест. Минимум остлеживать заказы:
       - Не переданы в производство в течение максимального срока отдачи в производство
       - Заказы в производстве, но расчетный срок вышел за пределы самого производства
       - Заказы не принятые менеджером в работу
   + Добавить логирование (ELK, Opensearch) по контрольным точкам. Для определения основных параметров бизнес-операций и времени совершения действия
   + Добавить трассировку (Jaeger) для понимания самых узких мест в системе заказов
9. После добавления наблюдаемости проводить постоянный аудит выявленных проблем и узких мест
    + В первый приоритет выявленные места отказов в анализ для понимания причин
    + При выявлении мест накопления (например не забираются по какой-либо причине задания с RabbitMQ) - выявлять причины и запланировать работы по их выявлению.
      - Например менеджеры берут самые "свежие" заказы. Не может ли быть ситуация, когда более старые заказы уходят из поля зрения. Можно поменять процедуру, когда не распределенные заказы будут распределяться автоматически после некоторого времени.
      - Увеличить количество потоков на MES при заборе заданий из RabbitMQ. Если MES не позволяет работать в более чем 1 поток, то рассмотреть возможность развертывания нескольких инстансов. Если MES можно распилить на микросервисы, то запланировать перевод на микросервисную архитектуры с дальнейшим масштабированием количества сервисов.
10. Присутствуют явные проблемы с CI/CD необходимо:
    + Максимально покрыть функционал автотестами
    + Разработать методологию релизов и критериев их готовности
    + Разработать devops практики с доведением деплоев до релизных и продуктивных сред в автоматическом режиме, а также обязательно предусмотреть средства и приемы отката изменений в случае неуспешности релизов
11. Рассмотреть варианты кэширования (напрашивается кэширование в системе заказов)
12. Разумное шардирование БД может привести к ускорению поисковых запросов.
13. При работе с CRM можно работать с Readonly репликами БД. 
14. MES фактически изолирована от магазина и CRM, поэтому БД хорошо шардируется по номеру заказа.

## Планирование изменений
1. В первую очередь повышаем устойчивость бизнеса:
   1. Наблюдение за системой отсутствует как класс. 
   Любые вносимые изменения не понятно как влияют целом на процессы и качество вносимых изменений можно понять только по косвенным признакам.
   Необходимо в первую очередь создать п.8 (анализ по схеме и проблемам) - внедрить мониторинг, логирование, трассировку.
   2. Провести предварительный аудит узких мест, ранжировать по тяжести проблемы и запланировать их устранение
2. Пока собирается статистика по п.1 добавить:
   1. Кэширование заказов для клиента (Cache Aside)
   2. Кэширование заказов для менеджера (Можно использовать Refresh-ahead для всех менеджеров)
   3. Кэширование загрузки 3d модели на запись (Write Through)
3. Внедрение CI/CD с релизной моделью 
4. Перевод MES на микросервисную архитектуру.
5. По всем базам проводим где надо шардирование (везде напрашивается шардирование по номеру заказа)
6. Для ShopDB можно добавить репликацию. И использовать readonly реплику для доступа CRM к сервисам ShopAPI 