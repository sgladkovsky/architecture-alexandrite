# Выбор и настройка мониторинга в системе

## Мотивация
1. Внедрение мониторинга позволяет проактивно отслеживать метрики бизнеса и упреждающе информировать бизнес о потенциальных проблемах в бизнес-процессах в онлайн режиме (недозагруженность/перегруженность производственных линий, просрочки по исполнению заказов, недозагруженность менеджеров и т.п.)
2. Добавление механизма для количественного измерения параметров бизнеса
3. Создание системы алертов для оперативного реагирования
4. Повышение устойчивости бизнес-процессов за счет оперативного выявления дефектов, а также дефектов после установки релизов.
5. Составление прогнозных моделей системы при различных характерах нагрузок. Как следствие работа с рисками и аргументированный подход к закупке оборудования и необходимости проведения работ по оптимизации системы.

## Выбор подхода к мониторингу
1. Мониторинг API: RED и USE
2. Мониторинг БД: USE
3. Мониторинг RabbitMQ: USE

## Внедряемые метрики

### Метрики API

| Метрика                                          | Описание                                      | Подход | MES API | CRM API | Shop API |
|--------------------------------------------------|-----------------------------------------------|--------|---------|---------|----------|
| Number of requests (RPS) (Request Rate)          | Текущая нагрузка на API                       | RED    | +       | +       | +        |
| Number of requests (RPS) (Request Rate) per user | Пользователи генерирующие аномальную нагрузку | RED    | +       | +       | +        |
| CPU % (Utilization)                              | Показывает загрузку процессора сервисом       | USE    | +       | +       | +        |
| Memory Utilisation (Utilization)                 | Потребление памяти сервисом                   | USE    | +       | +       | +        |
| Response time (latency) (Duration)               | Скорость ответа от API                        | RED    | +       | +       | +        |
| Number of HTTP (Request Rate/Success) (200, 500) | Количество успешных и не успешных ответов     | RED    | +       | +       | +        |

### Метрики БД

| Метрика               | Описание             | Подход | Shop DB | MES DB |  
|-----------------------|----------------------|--------|---------|--------|
| Memory Utilisation    | Использование памяти | USE    | +       | +      |   
| Number of connections | Количество коннектов | USE    | +       | +      |   
| Size                  | Размер БД            | USE    | +       | +      |   
 
### Метрики RabbitMQ

| Метрика                                | Описание                                                                 | Подход |  
|----------------------------------------|--------------------------------------------------------------------------|--------|
| Number of dead-letter-exchange letters | Количество отправленных сообщений, но не обработанных и помещенных в DLQ | USE    |   
| Number of message in flight            | Количество полученных, но не обработанных сообщений                      | USE    |   

## План действий

### I. Настройка инфраструктуры мониторинга
1. Выбор и развертывание time-series БД (TSDB)
    + Сбор требований к производительности и масштабируемости
    + Выбор TSDB из представленных на рынке
        - Учесть компетенцию команды с учетом сложности установки и настройки
        - Стоимость внедрения
        - Есть ли стоп-факторы (например БД должна быть в ЕРППО)
        - Учесть существующий технологический стек и возможность получения метрик из коробки
    + Развертывание TDSB
    + Настройка резервного копирования и восстановления
    
    Рекомендации Prometheus

2. Выбор и развертывание системы визуализации
   + Сбор требований
   + Выбор средства визуализации метрик
   + Развертывание системы визуализации
   + Интегрировать с TSDB

   Рекомендации Grafana   

3. Интеграция средства визуализации и TSDB

### II. Создание системы метрик и алертинга

1. По пункту "Внедряемые метрики" настроить сбор метрик в TSDB
2. Создать дашборды по метрикам
3. Создать алерты при выходе измеряемых параметров за критические значения.
   - За основу взять типовое значение нагрузки. Учесть пиковые значения дневные/недельные
   - Если было проведено нагрузочное тестирование - настроить алерты при приближении метрик к критическим значениям (70-80-90%)
